<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure Gateway</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #050508; --accent: #00ff9d; --card: rgba(20, 25, 35, 0.95); --danger: #ff0055; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        
        /* OVERLAY - REQUIRED FOR SOUND */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .start-btn { border: 1px solid var(--accent); color: var(--accent); padding: 15px 30px; border-radius: 30px; font-family: 'JetBrains Mono', monospace; animation: pulse 2s infinite; margin-top: 20px; font-weight: bold; }
        
        .card { width: 90%; max-width: 400px; background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 30px; text-align: center; position: relative; overflow: hidden; box-shadow: 0 0 30px rgba(0,255,157,0.1); opacity: 0; transition: opacity 1s; }
        .card.denied { border-color: var(--danger); box-shadow: 0 0 30px rgba(255,0,85,0.2); }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--accent); animation: scan 2s infinite linear; }
        
        h2 { margin-bottom: 10px; font-weight: 800; }
        p { color: #888; font-size: 0.8rem; margin-bottom: 20px; font-family: 'JetBrains Mono'; }
        
        .key-box { background: #000; border: 1px dashed #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; font-family: 'JetBrains Mono'; font-size: 1.4rem; color: var(--accent); min-height: 70px; display: flex; align-items: center; justify-content: center; }
        
        .btn { width: 100%; padding: 15px; background: var(--accent); color: #000; font-weight: 800; border: none; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; }

        @keyframes scan { 0% {top:0} 100% {top:100%} }
        @keyframes pulse { 0% {transform:scale(1)} 50% {transform:scale(1.05)} 100% {transform:scale(1)} }
    </style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>

    <!-- CLICK THIS TO ENABLE SOUND -->
    <div id="overlay" onclick="startSystem()">
        <i class="fas fa-fingerprint" style="font-size: 3rem; color: var(--accent);"></i>
        <div class="start-btn">TAP TO INITIALIZE</div>
        <div style="color: #666; font-size: 0.7rem; margin-top: 10px;">ESTABLISH SECURE CONNECTION</div>
    </div>

    <div class="card" id="mainCard">
        <div class="scan-line" id="scanLine"></div>
        <h2 id="statusTitle">VERIFYING...</h2>
        <p id="statusMsg">Checking security signature...</p>
        
        <div class="key-box" id="keyDisplay"><i class="fas fa-circle-notch fa-spin"></i></div>
        
        <button class="btn" id="copyBtn" onclick="copyKey()" disabled>PLEASE WAIT...</button>
    </div>

    <script>
        // --- CONFIG ---
        const DB_URL = "https://gateway-260ec-default-rtdb.firebaseio.com/"; 
        const AUTH_CODE = "dp_secure_2026_v8";

        // --- AUDIO ENGINE ---
        let synth = window.speechSynthesis;
        function speak(text) {
            if(!synth) return;
            synth.cancel(); // Stop any previous speech
            let utter = new SpeechSynthesisUtterance(text);
            utter.rate = 0.9;
            synth.speak(utter);
        }

        // --- STARTUP ---
        function startSystem() {
            // 1. Hide Overlay
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('mainCard').style.opacity = '1';
            
            // 2. Wake up Audio Engine (Crucial for mobile)
            if(synth) synth.resume();
            
            // 3. Start Particles
            initParticles();
            
            // 4. Run Logic
            processSecurity();
        }

        async function processSecurity() {
            const params = new URLSearchParams(window.location.search);
            const userAuth = params.get('auth');

            await new Promise(r => setTimeout(r, 1000)); // Fake scanning delay

            // CHECK 1: Auth Code
            if(userAuth !== AUTH_CODE) {
                denyAccess("Invalid Link Signature");
                return;
            }

            // CHECK 2: Anti-Refresh
            if(window.performance && performance.navigation.type === 1) {
                denyAccess("Refresh Detected. Link Expired.");
                return;
            }

            // CHECK 3: Session Burn
            if(sessionStorage.getItem('dp_key_generated')) {
                denyAccess("Link Already Used");
                return;
            }

            // SECURITY PASSED -> HIDE URL IMMEDIATELY
            // This prevents them from copying the working link
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Mark session as used
            sessionStorage.setItem('dp_key_generated', 'true');
            
            generateAndShowKey();
        }

        async function generateAndShowKey() {
            try {
                // Generate Key
                const rnd = Math.random().toString(36).substring(2, 7).toUpperCase();
                const newKey = "DP-" + rnd;

                // Save to Database
                const target = DB_URL.endsWith('/') ? `${DB_URL}ValidKeys/${newKey}.json` : `${DB_URL}/ValidKeys/${newKey}.json`;
                await fetch(target, {
                    method: 'PUT',
                    body: JSON.stringify({ "Hours": 24, "Created": Date.now() })
                });

                // UI Success
                document.getElementById('statusTitle').innerText = "ACCESS GRANTED";
                document.getElementById('statusTitle').style.color = "#00ff9d";
                document.getElementById('statusMsg').innerText = "Key generated successfully.";
                document.getElementById('keyDisplay').innerText = newKey;
                
                const btn = document.getElementById('copyBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-copy"></i> COPY KEY';
                
                speak("Access Granted. Key Generated.");

            } catch(e) {
                denyAccess("Database Connection Failed");
            }
        }

        function denyAccess(reason) {
            const card = document.getElementById('mainCard');
            card.classList.add('denied');
            document.querySelector('.scan-line').style.background = "#ff0055";
            
            document.getElementById('statusTitle').innerText = "ACCESS DENIED";
            document.getElementById('statusTitle').style.color = "#ff0055";
            document.getElementById('statusMsg').innerText = reason;
            document.getElementById('keyDisplay').innerText = "BLOCKED";
            document.getElementById('keyDisplay').style.color = "#ff0055";
            
            const btn = document.getElementById('copyBtn');
            btn.innerHTML = "SYSTEM LOCKED";
            btn.style.background = "#ff0055";
            
            speak("Access Denied. Security Protocol Engaged.");
        }

        function copyKey() {
            const txt = document.getElementById('keyDisplay').innerText;
            navigator.clipboard.writeText(txt);
            document.getElementById('copyBtn').innerText = "COPIED!";
            setTimeout(() => document.getElementById('copyBtn').innerHTML = '<i class="fas fa-copy"></i> COPY KEY', 2000);
        }

        // --- VISUALS ---
        function initParticles() {
            const c = document.getElementById('bgCanvas');
            const ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            let p = []; for(let i=0; i<40; i++) p.push({x: Math.random()*c.width, y: Math.random()*c.height, v: Math.random()*0.5});
            function anim() {
                ctx.clearRect(0,0,c.width,c.height);
                ctx.fillStyle = '#00ff9d'; ctx.globalAlpha = 0.2;
                p.forEach(e => { e.y -= e.v; if(e.y < 0) e.y = c.height; ctx.beginPath(); ctx.arc(e.x, e.y, 1, 0, Math.PI*2); ctx.fill(); });
                requestAnimationFrame(anim);
            }
            anim();
        }
    </script>
</body>
</html>